<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/header :: head"></head>

<body class="dashboard dashboard_1">
    <div class="full_container">
        <div class="inner_container">
            <nav id="sidebar">
                <menu th:replace="fragments/menu :: menu"></menu>
            </nav>
            <!-- Include the menu -->

            <!-- right content -->
            <div id="content">
                <!-- topbar -->
                <div class="topbar">
                    <nav class="navbar navbar-expand-lg navbar-light">
                        <div class="full">
                            <button type="button" id="sidebarCollapse" class="sidebar_toggle"><i
                                    class="fa fa-bars"></i></button>
                            <div class="logo_section">
                                <img class="img-responsive" src="images/logo/logo.png" alt="#" />
                            </div>
                            <div class="right_topbar">
                                <div class="icon_info">
                                    <ul class="user_profile_dd">
                                        <li>
                                            <a class="dropdown-toggle" data-toggle="dropdown"><span class="name_user"
                                                    th:text="${theuserid}"></span></a>
                                            <div class="dropdown-menu">
                                                <a class="dropdown-item" href="logout"><span>Log Out</span> <i
                                                        class="fa fa-sign-out"></i></a>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </nav>
                </div>
                <!-- end topbar -->

                <!-- dashboard inner -->

                <div class="midde_cont">
                    <div class="container-fluid">
                        <div class="row column_title">
                            <div class="col-md-12">
                                <div class="page_title">
                                    <h2>Loans From and To </h2>
                                </div>
                            </div>
                        </div>
                        <!-- The content Start  But Change Heading-->

                        <div class="row column4 graph">
                            <div class="container-fluid">
                                <div class="dash_blog">
                                    <div class="dash_blog_inner">
                                        <div class="task_list_main">
                                            <form name="form"  th:object="${Loans_from_toWrapper}" th:action="@{/loansFromAndTo/saveAll}" method="post">
                                                <table border="0" id="data-table"   width="98%"> 
                                                    <thead>
                                                        <tr>
                                                            
                                                            <Td Align=Center COlspan=1>
                                                            OGC Name<br>
                                                            </td>
                                                            <Td Align=Center COlspan=1>
                                                            Loans <br> Received
                                                            </td>
                                                    
                                                            <Td Align=Center COlspan=1>
                                                            Loans <br> Given
                                                            </td>

                                                        </tr>	
                                                    </thead>
                                                    <tbody>
                                                        <!-- Loop through saved records and pre-populate rows -->
                                                        <tr th:each="loans_from_to, iterStat : ${loans_from_toList}">
                                                            <td>
                                                                <select  class="form-control-sm" th:attr="name='loans_from_toList[' + ${iterStat.index} + '].ccompname'">
                                                                    <option th:each="company : ${companies}"
                                                                        th:value="${company.ccompcode}"
                                                                        th:text="${company.ccompname}"
                                                                        th:selected="${company.ccompcode == loans_from_to.ccompname}">
                                                                    </option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <input type="number" size="10" style="text-align:right;" class="form-control"
                                                                th:attr="name='loans_from_toList[' + ${iterStat.index} + '].loan_from'" 
                                                                    th:value="${loans_from_to.loan_from}">
                                                            </td>
                                                            <td> 
                                                                <input type="number" size="10" style="text-align:right;" class="form-control"
                                                                th:attr="name='loans_from_toList[' + ${iterStat.index} + '].loan_to'" 
                                                                    th:value="${loans_from_to.loan_to}">
                                                            </td>
                                                            
                                                            <td>
                                                                <input size="10" type="hidden" 
                                                                th:attr="name='loans_from_toList[' + ${iterStat.index} + '].ccompcode'" 
                                                                    th:value="${loans_from_to.ccompcode}">
                                                           
                                                                <input size="10" type="hidden"
                                                                th:attr="name='loans_from_toList[' + ${iterStat.index} + '].cyear'" 
                                                                    th:value="${loans_from_to.cyear}">

                                                                <input size="10" type="hidden"
                                                                th:attr="name='loans_from_toList[' + ${iterStat.index} + '].cmonth'" 
                                                                    th:value="${loans_from_to.cmonth}">
                                                                    <img class="img-responsive" src="images/logo/delete.png" onclick="deleteRow(this)" />
                                                                
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                <br/>
                                                <button type="button" class="btn cur-p btn-success"  onclick="addRow()">Add Row</button>
                                                &nbsp;&nbsp;
                                                <button type="submit" class="btn cur-p btn-primary">Save</button>
                                                &nbsp;&nbsp;
                                                <Input Type="button" Name=cmdCancel Value='Cancel' class="btn cur-p btn-danger"  onclick="cancel(form)" >

                                                <input type="hidden"   id="deletedRows" name="deletedRows" value="[]">
                                            
                                            
                                            <script th:inline="javascript">
                                                let rowIndex = 0;
                                                /*<![CDATA[*/
                                                let companies = JSON.parse(/*[[${companiesJson}]]*/ '[]');
                                                //console.log(companies);
                                                /*]]>*/
                                                // Function to dynamically add a new row
                                                function addRow(existingData = {}) {
                                                    //alert(/*[[${theCompanyCode}]]*/);
                                                    let theCompanyCode = /*[[${theCompanyCode}]]*/;
                                                    let theYear = /*[[${theYear}]]*/;
                                                    let theMonth = /*[[${theMonth}]]*/;
                                                    //alert("code = " + theCompanyCode);
                                                    //alert("theYear = " + theYear);
                                                    //alert("theMonth = " + theMonth);
                                                    let table = document.getElementById("data-table");
                                                    let rowCount = table.rows.length - 1; // Skip header row
                                                    let row = table.insertRow();

                                                    
                                                    let companyCell = row.insertCell(0);
                                                    let loan_from = row.insertCell(1);
                                                    let loan_to = row.insertCell(2);
                                                    let ccompcode = row.insertCell(3);
                                                    let cyear = row.insertCell(4);
                                                    let cmonth = row.insertCell(5);
                                                    let deleteCell = row.insertCell(6);

                                                    // Create dropdown for company, pre-select based on existing data if provided
                                                    let select = document.createElement("select");
                                                    select.classList.add("form-control-sm");
                                                    select.name = `loans_from_toList[${rowCount}].ccompname`; // Store company code in description field

                                                    companies.forEach(company => {
                                                        let option = document.createElement("option");
                                                        option.value = company.ccompcode;
                                                        option.text = company.ccompname;

                                                        // Pre-select the option if existing data matches
                                                        if (existingData.ccompname === company.ccompcode) {
                                                            option.selected = true;
                                                        }

                                                        select.appendChild(option);
                                                    });

                                                    companyCell.appendChild(select);

                                                    // Add input fields for actMtdBal and bgtMtdBal, pre-fill with existing data if provided
                                                    loan_from.innerHTML = `<input type="number" style="text-align:right;" class="form-control" size="10" name="loans_from_toList[${rowCount}].loan_from" value="${existingData.loan_from || ''}">`;
                                                    loan_to.innerHTML = `<input type="number" style="text-align:right;" class="form-control" size="10" name="loans_from_toList[${rowCount}].loan_to" value="${existingData.loan_to || ''}">`;
                                                    

                                                    ccompcode.innerHTML = `<input type="hidden"  name="loans_from_toList[${rowCount}].ccompcode" value="${theCompanyCode || ''}">`;
                                                    cyear.innerHTML =   `<input type="hidden"  name="loans_from_toList[${rowCount}].cyear" value="${theYear || ''}">`;
                                                    cmonth.innerHTML = `<input type="hidden" size="10"  name="loans_from_toList[${rowCount}].cmonth" value="${theMonth || ''}">`;
                                                    
                                                    
                                                    // Add delete button
                                                    
                                                    //deleteCell.innerHTML = '<button type="button" class="btn cur-p btn-danger" onclick="deleteRow(this)">Delete</button>';
                                                    deleteCell.innerHTML = '<img class="img-responsive" src="images/logo/delete.png" onclick="deleteRow(this)" />';
                                                    
                                                }

                                                let deletedRows = [];

                                                function deleteRow(button) {
                                                   /* part 1
                                                    let row = button.parentElement.parentElement;
                                                    row.remove();
                                                    */
                                                   /* part 2
                                                    let row = button.parentNode.parentNode;
                                                    row.parentNode.removeChild(row);

                                                    // Re-index the remaining rows
                                                    reIndexRows();
                                                    */
                                                    

                                                    //let row = document.querySelector('#data-table tbody tr');
                                                    let row = button.parentElement.parentElement;
                                                    let ccompcode = row.querySelector('input[name^="loans_from_toList"][name$=".ccompcode"]').value;
                                                    //alert(ccompcode);
                                                    let cyear = row.querySelector('input[name^="loans_from_toList"][name$=".cyear"]').value;
                                                    //alert(cyear);
                                                    let cmonth = row.querySelector('input[name^="loans_from_toList"][name$=".cmonth"]').value;
                                                    //alert(cmonth);
                                                    let ccompname = row.querySelector('select[name^="loans_from_toList"][name$=".ccompname"]').value;
                                                    //alert(description);

                                                    /*
                                                    let row = button.parentNode.parentNode;
                                                    let ccompcode = row.querySelector('input[name^="loans_from_toList"]').value;
                                                    let cyear = row.querySelector('input[name^="loans_from_toList"]').value;
                                                    let cmonth = row.querySelector('input[name^="loans_from_toList"]').value;
                                                    let description = row.querySelector('select[name^="loans_from_toList"]').value;
                                                    */
                                                    // Store the primary key values of the deleted row
                                                    deletedRows.push({
                                                        ccompcode: ccompcode,
                                                        cyear: cyear,
                                                        cmonth: cmonth,
                                                        ccompname: ccompname
                                                    });

                                                    // Remove the row from the table
                                                    row.remove();
                                                    reIndexRows();

                                                }
                                                function reIndexRows() {
                                                    let rows = document.querySelectorAll("#data-table tbody tr");

                                                    rows.forEach((row, index) => {
                                                        row.querySelectorAll('input, select').forEach(input => {
                                                            // Update the name attribute with the new index
                                                            let name = input.getAttribute('name');
                                                            if (name) {
                                                                let newName = name.replace(/\[\d+\]/, '[' + index + ']');
                                                                input.setAttribute('name', newName);
                                                            }
                                                        });
                                                    });
                                                    document.getElementById("deletedRows").value = JSON.stringify(deletedRows);
                                                }
                                                // Optionally, preload some data if you're editing existing records
                                                $(document).ready(function () {
                                                    // Example of adding existing rows
                                                    // addRow({ccompcode: '001', cmonth: '01', cyear: '2024', description: 'Company A'});
                                                });

                                                function cancel(form)
                                                    {
                                                        form.action="/safcancel";
                                                        form.submit();
                                                    }
                                                </script>    
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- The content End -->
                    <div class="container-fluid">
                        <div class="footer">
                            <footer th:replace="fragments/footer :: footer"></footer>
                        </div>
                    </div>
                    <!-- end dashboard inner -->
                </div>
                <!-- end content -->
            </div>
        </div>

        <!-- Include the footer 
        <div th:replace="fragments/footer :: foot"></div>
        -->
    </div>
    </div>
</body>

</html>